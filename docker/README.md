# Docker Setup for myrag Application

This directory contains the Docker setup for the myrag application, including all necessary services for development and monitoring.

## Services

- **FastAPI Application**: Main application running on Uvicorn
- **Nginx**: Web server for serving the FastAPI application
- **PostgreSQL (pgvector)**: Vector-enabled database for storing embeddings
- **Postgres-Exporter**: Exports PostgreSQL metrics for Prometheus
- **Qdrant**: Vector database for similarity search
- **Prometheus**: Metrics collection
- **Grafana**: Visualization dashboard for metrics
- **Node-Exporter**: System metrics collection

## Setup Instructions

### 1. Set up environment files

Create your environment files from the examples:

```bash
# Create all required .env files from examples
cd docker/env
cp .env.example.app .env.app
cp .env.example.postgres .env.postgres
cp .env.example.grafana .env.grafana
cp .env.example.postgres-exporter .env.postgres-exporter

# Setup the Alembic configuration for the FastAPI application
cd ..
cd docker/myrag
cp alembic.example.ini alembic.ini

### 2. Start the services

```bash
cd docker
docker compose up --build -d
```

To start only specific services:

```bash
docker compose up -d fastapi nginx pgvector qdrant
```

If you encounter connection issues, you may want to start the database services first and let them initialize before starting the application:

```bash
# Start databases first
docker compose up -d pgvector qdrant postgres-exporter
# Wait for databases to be healthy
sleep 30
# Start the application services
docker compose up fastapi nginx prometheus grafana node-exporter --build -d
```

In case deleting all containers and volumes is necessary, you can run:

```bash
docker compose down -v --remove-orphans
```

### 3. Access the services

- FastAPI Application: http://localhost:8000
- FastAPI Documentation: http://localhost:8000/docs
- Nginx (serving FastAPI): http://localhost
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000
- Qdrant UI: http://localhost:6333/dashboard

## Volume Management

### Managing Docker Volumes

Docker volumes are used to persist data generated by and used by Docker containers. Here are some commands to manage your volumes:

1. **List all volumes**:
   ```bash
   docker volume ls
   ```
2. **Inspect a volume**:
   ```bash
   docker volume inspect <volume_name>
   ```

   - list files in a volume:
   ```bash
   docker run --rm -v <volume_name>:/data busybox ls -l /data
   ```

3. **Remove a volume**:
   ```bash
   docker volume rm <volume_name>
   ```
4. **Prune unused volumes**:
   ```bash
    docker volume prune
    ```

5. **Backup volume for migration**:
   ```bash
    docker run --rm -v <volume_name>:/volume -v $(pwd):/backup alpine tar cvf /backup/backup.tar /volume
    ```

6. **Restore volume from backup**:
   ```bash
    docker run --rm -v <volume_name>:/volume -v $(pwd):/backup alpine sh -c "cd /volume && tar xvf /backup/backup.tar --strip 1"
    ```

7. **Remove all volumes**:
    ```bash
    docker volume rm $(docker volume ls -q)
    ```

**NOTE**: For PostgreSQL specifically, you might want to consider using PostgreSQL's built-in tools like `pg_dump` and `pg_restore` for more reliable backups, especially for live databases.

## Monitoring

### FastAPI Metrics

FastAPI is configured to expose Prometheus metrics at the `/metrics` endpoint. These metrics include:

- Request counts
- Request latencies
- Status codes

Prometheus is configured to scrape these metrics automatically.

### Visualizing Metrics in Grafana

1. Log into Grafana at http://localhost:3000 (default credentials: admin/admin_password)
2. Add Prometheus as a data source (URL: http://prometheus:9090)
3. Import dashboards for FastAPI, PostgreSQL, and Qdrant

#### Dashboards URLs

https://grafana.com/grafana/dashboards/18739-fastapi-observability/

https://grafana.com/grafana/dashboards/1860-node-exporter-full/

https://grafana.com/grafana/dashboards/23033-qdrant/

https://grafana.com/grafana/dashboards/12485-postgresql-exporter/


## Development Workflow

The FastAPI application is configured with hot-reloading. Any changes to the code in the `src/` directory will automatically reload the application.

## Troubleshooting

### Connection Errors

If you see connection errors when starting the services:

1. **Database Connection Refused**: This often happens when the FastAPI app tries to connect to databases before they're ready.
   ```
   Connection refused: [Errno 111] Connection refused
   ```
   
   Solutions:
   - Start database services first, wait, then start the application
   - Check database logs: `docker compose logs pgvector`
   - Ensure your database credentials in `.env.app` match those in `.env.postgres`

2. **Restart the FastAPI service** after databases are running:
   ```bash
   docker compose restart fastapi
   ```

3. **Check service status**:
   ```bash
   docker compose ps
   ```

4. **View logs** for more details:
   ```bash
   docker compose logs --tail=100 fastapi
   docker compose logs --tail=100 pgvector
   ```

# Docker Container and Build Explanation

## üê≥ Working Inside the Docker Container

When you are inside the Docker project directory and you run:

``` bash
sudo docker compose exec fastapi bash
```

you open a **bash shell inside the FastAPI container**.

Inside this container, your working directory is the **`/app` folder**,
which corresponds to your local **`src/app` directory** during
development.

So, when you list the files:

``` bash
ls
```

you will see the same folders and files that exist inside the `app`
directory in `src`.

------------------------------------------------------------------------

## üîÑ Why You Must Use `--build` After Changing Code

If you modify any files in the `src` directory, Docker **does not
automatically rebuild the image** when you run:

``` bash
sudo docker compose up
```

Docker may reuse **old cached build layers**, meaning your changes will
**not** appear inside the running container.

To force Docker to rebuild the container with the latest code, you must
use:

``` bash
sudo docker compose up --build
```

This command instructs Docker to **ignore old cached builds** and
rebuild the image from scratch, ensuring your newest code is included.

------------------------------------------------------------------------

## ‚úÖ Summary

-   `docker compose exec fastapi bash` ‚Üí opens a shell inside the
    container's `/app` directory\
-   `/app` maps to your local `src/app`\
-   After editing code, always use `--build` to avoid running outdated
    code
------------------------------------------------------------------------


# Restarting Nginx in Docker

When you make changes to the **`nginx` default.conf** file, you need to restart the Nginx service inside the Docker container to apply the changes.

Run the following command:

```bash
sudo docker compose restart nginx
```
This will stop and start the Nginx container, ensuring your new configuration takes effect.